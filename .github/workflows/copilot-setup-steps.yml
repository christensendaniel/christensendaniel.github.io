name: Copilot Setup and Site Verification

# This workflow can be triggered manually or on schedule to verify site accessibility
# It should NOT run on push to avoid racing with the deployment process
on:
  workflow_dispatch:
    inputs:
      deployment_url:
        description: 'Deployment URL to test'
        required: false
        default: 'https://christensendaniel.com'
  schedule:
    # Run daily at 12:00 UTC to verify site health
    - cron: '0 12 * * *'

permissions:
  contents: read

jobs:
  verify-site-access:
    name: Load and Verify christensendaniel.com
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          npm ci
          echo "‚úÖ Dependencies installed"
      
      - name: Install Playwright browsers
        run: |
          echo "üé≠ Installing Playwright browsers..."
          npx playwright install --with-deps chromium
          echo "‚úÖ Playwright browsers installed"
      
      - name: Quick HTML structure check
        env:
          DEPLOYMENT_URL: ${{ inputs.deployment_url || 'https://christensendaniel.com' }}
        run: |
          echo "üîç Running quick HTML structure verification..."
          echo "Target URL: $DEPLOYMENT_URL"
          npm run quick-check
        continue-on-error: false
      
      - name: Comprehensive site verification
        env:
          DEPLOYMENT_URL: ${{ inputs.deployment_url || 'https://christensendaniel.com' }}
        run: |
          echo "üîç Running comprehensive site verification..."
          echo "Target URL: $DEPLOYMENT_URL"
          npm run test:deployed-site
        continue-on-error: true
        id: site_test
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: site-verification-results
          path: |
            test-results/
          retention-days: 7
          if-no-files-found: warn
      
      - name: Verify site accessibility summary
        if: always()
        run: |
          echo "## üåê Site Accessibility Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target URL:** ${{ inputs.deployment_url || 'https://christensendaniel.com' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Verification Time:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f test-results/deployment-test-report.json ]; then
            echo "### Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat test-results/deployment-test-report.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Verification Steps Completed" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Environment setup" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ HTML structure validation" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Comprehensive site testing" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Screenshot capture" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Full test results and screenshots are available in the artifacts section above." >> $GITHUB_STEP_SUMMARY
      
      - name: Check verification status
        if: always()
        run: |
          if [ "${{ steps.site_test.outcome }}" == "failure" ]; then
            echo "‚ö†Ô∏è  Site verification completed with warnings or errors"
            echo "Please review the test results artifact for details"
            exit 1
          else
            echo "‚úÖ Site verification passed successfully"
            echo "christensendaniel.com is accessible and rendering correctly"
          fi
